#!/bin/bash

readonly BMC_IP='10.146.160.10'
readonly PWM_MANUAL='0x30 0x70 0x66 0x02 0x01'
readonly PWM_AUTO='0x30 0x70 0x66 0x02 0x00'
readonly PWM_SET_DUTY='0x30 0x70 0x66 0x01 0x00 0x14'
readonly IPMI_CMD="ipmitool -U ADMIN -P ADMIN -H ${BMC_IP}"
readonly IPMI_READ_FAN="${IPMI_CMD} sdr"
readonly RAW_CMD="${IPMI_CMD} raw ${PWM_SET_DUTY}"
readonly SLEEP='sleep 6'

${IPMI_CMD} raw ${PWM_MANUAL}

${RAW_CMD} 0x00 0x14
${RAW_CMD} 0x01 0x14
${RAW_CMD} 0x02 0x14
${RAW_CMD} 0x03 0x14
#${IPMI_CMD} raw 0x30 0x70 0xc7 0x14
${SLEEP}
${IPMI_READ_FAN} | grep 'FAN' | grep -v 'ns'

${RAW_CMD} 0x00 0x28
${RAW_CMD} 0x01 0x28
${RAW_CMD} 0x02 0x28
${RAW_CMD} 0x03 0x28
#${IPMI_CMD} raw 0x30 0x70 0xc7 0x28
${SLEEP}
${IPMI_READ_FAN} | grep 'FAN' | grep -v 'ns'

${RAW_CMD} 0x00 0x40
${RAW_CMD} 0x01 0x40
${RAW_CMD} 0x02 0x40
${RAW_CMD} 0x03 0x40
#${IPMI_CMD} raw 0x30 0x70 0xc7 0x40
${SLEEP}
${IPMI_READ_FAN} | grep 'FAN' | grep -v 'ns'

${RAW_CMD} 0x00 0x64
${RAW_CMD} 0x01 0x64
${RAW_CMD} 0x02 0x64
${RAW_CMD} 0x03 0x64
#${IPMI_CMD} raw 0x30 0x70 0xc7 0x64
${SLEEP}
${IPMI_READ_FAN} | grep 'FAN' | grep -v 'ns'


${IPMI_CMD} raw ${PWM_AUTO}
